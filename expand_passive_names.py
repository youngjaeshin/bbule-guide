#!/usr/bin/env python3
"""
expand_passive_names.py
패시브 약어를 공식 명칭으로 확장.
build_mercenary_passive.py + fix_passive_multiplier.py 실행 후에 적용.
"""

import json
import re

MERC_JSON = 'web/data_mercenaries.json'
INDEX_HTML = 'web/index.html'

# 약어 → 공식 명칭 매핑 (긴 것부터 매칭하도록 정렬됨)
ABBREV_MAP = {
    # ── 모든 X 용병의 Y (복합 약어, 가장 긴 것 먼저) ──
    '모용추뎀증폭': '모든 용병의 추가 데미지 증폭',
    '모용마강배증': '모든 용병의 마법 강타 배수 증폭',
    '모용강배증폭': '모든 용병의 강타 배수 증폭',
    '모용강배증': '모든 용병의 강타 배수 증폭',
    '모용저항력무시': '모든 용병의 저항력 무시',
    '모용트리니티뎀': '모든 트리니티 용병의 데미지',
    '모용시작렙': '모든 용병의 시작 레벨',
    '모용성장뎀': '모든 용병의 성장 데미지',
    '모용집공뎀': '모든 용병의 집중 공격 데미지',
    '모용추클뎀': '모든 용병의 추가 클릭 데미지',
    '모용혼강배': '모든 혼합 용병의 강타 배수',
    '모용마강확': '모든 용병의 마법 강타 확률',
    '모혼용강배증': '모든 혼합 용병의 강타 배수 증폭',
    '모틀강배증': '모든 트리니티 용병의 강타 배수 증폭',
    '모용최렙': '모든 용병의 최대 레벨',
    '모용추뎀': '모든 용병의 추가 데미지',
    '모용클뎀': '모든 용병의 클릭 데미지',
    '모용베뎀': '모든 용병의 베이스 데미지',
    '모용연뎀': '모든 용병의 연타 데미지',
    '모용최뎀': '모든 용병의 최종 데미지',
    '모용신뎀': '모든 용병의 신성 데미지',
    '모용강배': '모든 용병의 강타 배수',
    '모용강확': '모든 용병의 강타 확률',
    '모용치배': '모든 용병의 치명타 배수',
    '모용행배': '모든 용병의 행운 배수',
    '모용피감': '모든 용병의 피해 감소',
    '모용공속': '모든 용병의 공격 속도',
    '모용공확': '모든 용병의 공포 극복 확률',
    '모용뎀': '모든 용병의 데미지',
    '모용 치배': '모든 용병의 치명타 배수',
    '모용 행배': '모든 용병의 행운 배수',
    '용클뎀': '용병 클릭 데미지',

    # ── 타입별 용병 (복합) ──
    '혼합용병강배': '혼합 용병의 강타 배수',
    '마법용병강배': '마법 용병의 강타 배수',
    '소클배증폭': '소울 클릭 배수 증폭',
    '마용최종뎀': '마법 용병의 최종 데미지',
    '마용병공속': '마법 용병의 공격 속도',
    '마용강배': '마법 용병의 강타 배수',
    '물용강배': '물리 용병의 강타 배수',
    '카오스강배': '카오스 강타 배수',

    # ── 2-3글자 약어 ──
    '혼합강배': '혼합 강타 배수',
    '혼합강확': '혼합 강타 확률',
    '혼합공속': '혼합 공격 속도',
    '혼용강배': '혼합 용병의 강타 배수',
    '트리행배': '트리니티 행운 배수',
    '트리니티뎀': '트리니티 데미지',
    '에메랄드드랍확률': '에메랄드 드랍 확률',
    '뿔레오브드랍확률': '뿔레 오브 드랍 확률',
    '토파즈 드랍확률': '토파즈 드랍 확률',
    '자수정 드랍확': '자수정 드랍 확률',
    '침략자추뎀': '침략자 추가 데미지',
    '침략자 추뎀': '침략자 추가 데미지',
    '최대모집횟수': '최대 모집 횟수',
    '환생스테이지': '환생 스테이지',
    '용병슬롯추가': '용병 슬롯 추가',
    '카강확': '카오스 강타 확률',
    '침최뎀': '침략자 최종 데미지',
    '침락쟈 최뎀': '침략자 최종 데미지',
    '소클배': '소울 클릭 배수',
    '소클확': '소울 클릭 확률',
    '클크배': '클릭 크리티컬 배수',
    '클크확': '클릭 크리티컬 확률',
    '성장뎀': '성장 데미지',
    '추클뎀': '추가 클릭 데미지',
    '자클뎀': '자동 클릭 데미지',
    '자클확': '자동 클릭 확률',
    '물저감': '물리 저항 감소',
    '마저감': '마법 저항 감소',
    '클저감': '클릭 저항 감소',
    '물최뎀': '물리 최종 데미지',
    '마최뎀': '마법 최종 데미지',
    '물공속': '물리 공격 속도',
    '오브확': '오브 확률',
    '루비확': '루비 확률',
    '강배': '강타 배수',
    '강확': '강타 확률',
    '추뎀': '추가 데미지',
    '클뎀': '클릭 데미지',
    '베뎀': '베이스 데미지',
    '연뎀': '연타 데미지',
    '최뎀': '최종 데미지',
    '물뎀': '물리 데미지',
    '치배': '치명타 배수',
    '치확': '치명타 확률',
    '행배': '행운 배수',
    '행확': '행운 확률',
    '피감': '피해 감소',
    '체감': '체력 감소',
    '회감': '회피 감소',
    '카취': '카오스 취약성',
    '무관': '무효화 관통',
    '골획': '골드 획득량',
    '골저': '골드 저장량',
    '아획': '아이템 획득',
    '정수획': '정수 획득',
    '피확': '피격 확률',
    '공속': '공격 속도',
    '공확': '공포 극복 확률',
}


def expand_passive(text):
    """약어를 공식 명칭으로 확장."""
    if not text:
        return text
    result = text
    # 긴 약어부터 먼저 매칭 (부분 매칭 방지)
    for abbrev, full in sorted(ABBREV_MAP.items(), key=lambda x: -len(x[0])):
        result = result.replace(abbrev, full)
    return result


def main():
    with open(MERC_JSON, 'r', encoding='utf-8') as f:
        mercs = json.load(f)

    print("=== 패시브 약어 → 공식 명칭 확장 ===\n")

    changed = 0
    for m in mercs:
        if not m.get('passive'):
            continue
        old = m['passive']
        new = expand_passive(old)
        if old != new:
            changed += 1
            if changed <= 20:
                print(f"[{m['grade']}] {m['name']}")
                print(f"  전: {old}")
                print(f"  후: {new}\n")
        m['passive'] = new

    print(f"총 {changed}건 확장됨\n")

    # 전체 출력
    print("=== 최종 패시브 전체 ===\n")
    for m in mercs:
        p = m.get('passive')
        if p:
            print(f"[{m['grade']}] {m['name']}: {p}")

    # JSON 저장
    with open(MERC_JSON, 'w', encoding='utf-8') as f:
        json.dump(mercs, f, ensure_ascii=False, indent=1)
    print(f"\n{MERC_JSON} 저장 완료")

    # inline MERC_DATA 업데이트
    with open(INDEX_HTML, 'r', encoding='utf-8') as f:
        html = f.read()

    lines = html.split('\n')
    for i, line in enumerate(lines):
        if line.startswith('const MERC_DATA='):
            minified = json.dumps(mercs, ensure_ascii=False, separators=(',', ':'))
            lines[i] = f'const MERC_DATA={minified};'
            break

    with open(INDEX_HTML, 'w', encoding='utf-8') as f:
        f.write('\n'.join(lines))
    print(f"{INDEX_HTML} MERC_DATA 업데이트 완료")


if __name__ == '__main__':
    main()
